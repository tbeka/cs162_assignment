{% extends 'base.html' %}

{% block content %}
<h1 class="title">
    Welcome, {{ name }}!
</h1>

<div class="container">
    <!-- Form to Add New List -->
    <div class="box">
        <form action="{{ url_for('main.add_list') }}" method="post">
            <div class="field">
                <label class="label" for="title">New List Title</label>
                <div class="control">
                    <input class="input" type="text" id="title" name="title" placeholder="Enter new list title" required>
                </div>
            </div>
            <div class="control">
                <button type="submit" class="button is-link">Add List</button>
            </div>
        </form>
    </div>

    <!-- Existing Lists Display -->
    {% for list in lists %}
    <div class="box" style="position: relative;">
        <h2 class="title is-4" style="color: black;">{{ list.title }}</h2>
        <input id="input-{{ list.id }}" type="text" class="input" style="display: none;" onblur="saveTitle('{{ list.id }}')">
        <!-- Adjusted Delete Cross -->
        <form action="{{ url_for('main.delete_list', list_id=list.id) }}" method="post" style="position: absolute; top: 10px; right: 10px;">
            <button class="delete" type="submit" style="cursor: pointer;"></button>
        </form>
        <a onclick="toggleEdit('{{ list.id }}')" class="icon has-text-info" style="position: absolute; top: 10px; right: 40px; cursor: pointer;">
            <i class="fas fa-edit"></i>
        </a>
        
        <!-- Form to Add New Task -->
        <form action="{{ url_for('main.add_task', list_id=list.id) }}" method="post">
            <div class="field">
                <div class="control">
                    <input class="input" type="text" name="taskContent" placeholder="Enter new task" required>
                </div>
            </div>
            <div class="control">
                <button type="submit" class="button is-small is-link">Add Task</button>
            </div>
        </form>

        <ul>
            {% for item in list.items if item.parent_id is none %}
                {{ render_item(item) }}
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<script>
function toggleSubItems(itemId) {
    var element = document.getElementById('sub-items-' + itemId);
    if (element) {
        element.classList.toggle('is-hidden');
    }
}

function toggleEdit(listId) {
    const titleElement = document.getElementById(`title-${listId}`);
    const inputElement = document.getElementById(`input-${listId}`);
    if (inputElement.style.display === "none") {
        inputElement.style.display = "block";
        titleElement.style.display = "none";
        inputElement.value = titleElement.textContent;
        inputElement.focus();
    } else {
        inputElement.style.display = "none";
        titleElement.style.display = "block";
    }
}

function saveTitle(listId) {
    const inputElement = document.getElementById(`input-${listId}`);
    const title = inputElement.value;
    // Implement the save functionality here
    // For example, make an AJAX call to update the list title in the database
    console.log("Saving new title:", title, "for list ID:", listId);
    // After saving, you can update the title display and hide the input field:
    const titleElement = document.getElementById(`title-${listId}`);
    titleElement.textContent = title;
    toggleEdit(listId); // Hide the input field again
}
</script>

{% endblock %}

{% macro render_item(item, level=0) %}
<li>
    {{ item.content }}
    <!-- Button to delete task could be added here -->
    {% if item.children %}
    <a href="javascript:void(0);" onclick="toggleSubItems({{ item.id }})">Toggle Sub-Items</a>
    <ul id="sub-items-{{ item.id }}" class="{{ 'is-hidden' if level >= 1 }}">
        {% for sub_item in item.children %}
            {{ render_item(sub_item, level + 1) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}
