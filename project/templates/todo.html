{% extends 'base.html' %}

{% block content %}

<h1 class="title is-2">
    Welcome, {{ name }}!
</h1>

<div class="container">
    <!-- Button to Show Add New List Form -->
    <button class="button is-small is-info" onclick="toggleTaskForm()" style="margin-bottom: 20px;">Add New List</button>

    <!-- Form to Add New List, Initially Hidden -->
    <div id="add-task-form" class="box" style="display: none;">
        <form action="{{ url_for('main.add_list') }}" method="post">
            <div class="field">
                <label class="label" for="title">New List Title</label>
                <div class="control">
                    <input class="input" type="text" id="title" name="title" placeholder="Enter new list title" required>
                </div>
            </div>
            <div class="control">
                <button type="submit" class="button is-info">Add List</button>
            </div>
        </form>
    </div>

    <!-- Existing Lists Display -->
    {% for list in lists %}
    <div class="box" ondrop="drop(event)" ondragover="allowDrop(event)" data-list-id="{{ list.id }}" style="position: relative; margin-bottom: 20px;">
        <!-- Display List Title -->
        <div class="content"  style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div id="title-container-{{ list.id }}">
                <h2 class="title is-3" style="color: black; display: inline-block;">{{ list.title }}</h2>

            </div>
            <form id="edit-form-{{ list.id }}" action="{{ url_for('main.update_list_title', list_id=list.id) }}" method="post" style="display: none; width: 50%">
                <input type="text" class="input is-small" name="new_title" value="{{ list.title }}">
                <button type="submit" class="button is-info is-small">Save</button>
            </form>
        </div>

        <div class="buttons are-small" style="position: absolute; top: 10px; right: 10px;">
            <button class="button is-info is-small" onclick="toggleTaskForm('{{ list.id }}')">Add New Task</button>
            <a onclick="toggleEdit('{{ list.id }}')" class="button is-light is-small">Rename</a>
            <form action="{{ url_for('main.delete_list', list_id=list.id) }}" method="post">
                <button type="submit" class="button is-light is-small">Delete</button>
            </form>
        </div>

        <!-- Form to Add New Task, Initially Hidden, for each List -->
        <div id="add-task-form-{{ list.id }}" style="display: none;">
            <form action="{{ url_for('main.add_task', list_id=list.id) }}" method="post">
                <div class="field">
                    <div class="control">
                        <input class="input" type="text" name="taskContent" placeholder="Enter new task" required>
                    </div>
                </div>
                <div class="field">
                    <div class="control has-text-centered">
                        <button type="submit" class="button is-small is-info" style="margin-bottom: 20px;">Add Task</button>
                    </div>
                </div>
            </form>
        </div>
        <ul>
            {% for item in list.items if item.parent_id is none %}
            <li>
                <div class="card" draggable="true" ondragstart="drag(event)" id="task-{{ item.id }}" style="margin-bottom: 10px;">
                    <div class="card-content">
                        <div class="content"  style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
                            <div id="title-container-{{ item.id }}" style="width: 100%;">
                                <h2 class="title is-4" style="color: black; display: inline-block;">{{ item.content }}</h2>
                            </div>
                            <form id="edit-task-form-{{ item.id }}" action="{{ url_for('main.update_task', item_id=item.id) }}" method="post" style="display: none; width: 50%;">
                                <input type="text" class="input is-small" name="new_content" value="{{ item.content }}">
                                <button type="submit" class="button is-small is-info">Save</button>
                            </form>
                        </div>
                    </div>
                    <div class="buttons are-small" style="position: absolute; top: 10px; left: 10px;">
                    {% if item.children %}
                        <button class="button is-small is-light" onclick="toggleExpandCollapse('{{ item.id }}')">Expand/Collapse</button>
                    {% endif %}

                    </div>
                    <div class="buttons are-small" style="position: absolute; top: 10px; right: 10px;">
                        <button class="button is-info is-small" onclick="toggleAddTaskForm('add-subtask-form-{{ item.id }}')">Add Subtask</button>
                        <a href="javascript:void(0);" onclick="toggleEditTask('{{ item.id }}')" class="button is-small is-light">Rename</a>
                        <!-- Rename Task Form (Initially Hidden) -->

                        <form action="{{ url_for('main.delete_task', item_id=item.id) }}" method="post" style="display: inline;">
                            <button type="submit" class="button is-small is-light">Delete</button>
                        </form>
                        <!-- Additional buttons like "Add Subtask" can be added here following the same pattern -->


                    </div>
                    <!-- Form to Add Subtask, Initially Hidden -->
                    <div id="add-subtask-form-{{ item.id }}" style="display: none; margin: 0 auto; width: 80%;">
                        <form action="{{ url_for('main.add_task', list_id=list.id) }}" method="post">
                            <input type="hidden" name="parent_id" value="{{ item.id }}">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="text" name="taskContent" placeholder="Enter new subtask" required>
                                </div>
                            </div>
                            <div class="field">
                                <div class="control has-text-centered">
                                    <button type="submit" class="button is-small is-info" style="margin-bottom: 20px;">Add Subtask</button>
                                </div>
                            </div>
                        </form>
                    </div>



                    {% if item.children %}

                        <ul id="subtasks-{{ item.id }}" style="display: {{'none' if item.is_collapsed else 'block'}}; margin-left: 20px; margin-right: 20px">
                            {% for sub_item in item.children %}



                            <li>
                                <div class="card" style="margin-bottom: 10px;">
                                    <div class="card-content">
                                        <div class="content"  style="display: flex; justify-content: center; align-items: center; flex-direction: column;">

                                            <div id="title-container-{{ sub_item.id }}" style="width: 100%;">
                                                <h2 class="title is-5" style="color: black; display: inline-block;">{{ sub_item.content }}</h2>
                                            </div>
                                            <form id="edit-task-form-{{ sub_item.id }}" action="{{ url_for('main.update_task', item_id=sub_item.id) }}" method="post" style="display: none; width: 50%;">
                                                <input type="text" class="input is-small" name="new_content" value="{{ sub_item.content }}">
                                                <button type="submit" class="button is-small is-info">Save</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="buttons are-small" style="position: absolute; top: 10px; left: 10px;">

                                        {% if sub_item.children %}
                                            <button class="button is-small is-light" onclick="toggleExpandCollapse('{{ sub_item.id }}')">Expand/Collapse</button>
                                        {% endif %}

                                    </div>
                                    <div class="buttons are-small" style="position: absolute; top: 10px; right: 10px;">
                                        <button class="button is-info is-small" onclick="toggleAddTaskForm('add-subtask-form-{{ sub_item.id }}')">Add Subtask</button>
                                        <a href="javascript:void(0);" onclick="toggleEditTask('{{ sub_item.id }}')" class="button is-small is-light">Rename</a>
                                        <!-- Rename Task Form (Initially Hidden) -->

                                        <form action="{{ url_for('main.delete_task', item_id=sub_item.id) }}" method="post" style="display: inline;">
                                            <button type="submit" class="button is-small is-light">Delete</button>
                                        </form>
                                        <!-- Additional buttons like "Add Subtask" can be added here following the same pattern -->


                                    </div>
                                    <!-- Form to Add Subtask, Initially Hidden -->
                                    <div id="add-subtask-form-{{ sub_item.id }}" style="display: none; margin: 0 auto; width: 80%;">
                                        <form action="{{ url_for('main.add_task', list_id=list.id, parent_id=sub_item.id) }}" method="post">
                                            <input type="hidden" name="parent_id" value="{{ sub_item.id }}">
                                            <div class="field">
                                                <div class="control">
                                                    <input class="input" type="text" name="taskContent" placeholder="Enter new sub-subtask" required>
                                                </div>
                                            </div>
                                            <div class="field">
                                                <div class="control has-text-centered">
                                                    <button type="submit" class="button is-small is-info" style="margin-bottom: 20px;">Add subtask</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    




                                    <!-- Sub-subtasks display, if any -->
                                    {% if sub_item.children %}
                                        <ul id="subsubtasks-{{ sub_item.id }}" style="display: {{'none' if item.is_collapsed else 'block'}}; margin-left: 20px; margin-right: 20px;">
                                            {% for sub_sub_item in sub_item.children %}
                                            <li>
                                                <div class="card" style="margin-bottom: 10px;">
                                                    <div class="card-content">
                                                        <div class="content"  style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
                                                            <div id="title-container-{{ sub_sub_item.id }}" style="width: 100%;">
                                                                <h2 class="title is-6" style="color: black; display: inline-block;">{{ sub_sub_item.content }}</h2>
                                                            </div>
                                                            <form id="edit-task-form-{{ sub_sub_item.id }}" action="{{ url_for('main.update_task', item_id=sub_sub_item.id) }}" method="post" style="display: none; width: 50%;">
                                                                <input type="text" class="input is-small" name="new_content" value="{{ sub_sub_item.content }}">
                                                                <button type="submit" class="button is-small is-info">Save</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <div class="buttons are-small" style="position: absolute; top: 10px; left: 10px;">

                                                    </div>
                                                    <div class="buttons are-small" style="position: absolute; top: 10px; right: 10px;">
                                                        <a href="javascript:void(0);" onclick="toggleEditTask('{{ sub_sub_item.id }}')" class="button is-small is-light">Rename</a>
                                                        <!-- Rename Task Form (Initially Hidden) -->

                                                        <form action="{{ url_for('main.delete_task', item_id=sub_sub_item.id) }}" method="post" style="display: inline;">
                                                            <button type="submit" class="button is-small is-light">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% endif %} 
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<script>
function toggleTaskForm(listId) {
    // Check if listId is provided, if not, use the ID for the "Add New List" form
    var formId = listId ? 'add-task-form-' + listId : 'add-task-form';
    const form = document.getElementById(formId);
    form.style.display = form.style.display === "none" ? "block" : "none";
}

function toggleEditTask(itemId) {
    const titleContainer = document.getElementById(`title-container-${itemId}`);
    const editForm = document.getElementById(`edit-task-form-${itemId}`);
    if (editForm.style.display === "none") {
        editForm.style.display = "block"; // Show the edit form
        titleContainer.style.display = "none"; // Hide the title
    } else {
        editForm.style.display = "none"; // Hide the edit form
        titleContainer.style.display = "block"; // Show the title
    }
}

function toggleEdit(listId) {
    const titleContainer = document.getElementById(`title-container-${listId}`);
    const editForm = document.getElementById(`edit-form-${listId}`);
    if (editForm.style.display === "none") {
        editForm.style.display = "block";
        titleContainer.style.display = "none";
    } else {
        editForm.style.display = "none";
        titleContainer.style.display = "block";
    }
}

function toggleAddTaskForm(formId) {
    var form = document.getElementById(formId);
    form.style.display = form.style.display === "none" ? "block" : "none";
}

function toggleVisibility(elementId) {
    var element = document.getElementById(elementId);
    if (element.style.display === "none") {
        element.style.display = "block";
    } else {
        element.style.display = "none";
    }
}

function allowDrop(ev) {
    ev.preventDefault(); // This allows the drop by preventing the default behavior
    var target = ev.target;

    // Check if the target is a list container; if not, do not allow dropping
    while(target && target.getAttribute('data-list-id') === null) {
        target = target.parentNode; // Move up in the DOM tree
        if(target.nodeName === "BODY") { // Stop if the body element is reached without finding a list container
            ev.stopPropagation(); // Stop the event from bubbling further
            return false; // Prevent drop
        }
    }
}

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id); // Set the id of the dragged element
}

function drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    var target = ev.target;

    // Ensure the drop target is a list container
    while(target && target.getAttribute('data-list-id') === null) {
        target = target.parentNode;
        if(target.nodeName === "BODY") return; // If it's not a list container, exit
    }

    var droppedElement = document.getElementById(data);
    if(target && target.classList.contains('box')) { // Optionally, check if target has a specific class indicating it's a drop zone
        target.appendChild(droppedElement); // Only append if the target is correct

        var itemId = data.split('-')[1]; // Assuming the ID format is "item-{id}"
        var newListId = target.getAttribute('data-list-id');

        // AJAX call to update the backend
        fetch('/update_item_position', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({item_id: itemId, new_list_id: newListId}),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
}

function toggleExpandCollapse(itemId) {
    fetch(`/toggle-collapse/${itemId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const subtasks = document.getElementById(`subtasks-${itemId}`);
                subtasks.style.display = data.is_collapsed ? 'none' : 'block';
            } else {
                console.error('Failed to toggle the collapsed state.');
            }
        })
        .catch(error => console.error('Error:', error));
}
</script>



{% endblock %}