{% extends 'base.html' %}

{% block content %}
<h1 class="title">
    Welcome, {{ name }}!
</h1>

<div class="container">
    <!-- Form to Add New List -->
    <div class="box">
        <form action="{{ url_for('main.add_list') }}" method="post">
            <div class="field">
                <label class="label" for="title">New List Title</label>
                <div class="control">
                    <input class="input" type="text" id="title" name="title" placeholder="Enter new list title" required>
                </div>
            </div>
            <div class="control">
                <button type="submit" class="button is-link">Add List</button>
            </div>
        </form>
    </div>

    <!-- Existing Lists Display -->
    {% for list in lists %}
    <div class="box" style="position: relative;">
        <!-- Display List Title or Input Field Based on Editing State -->
        <div id="title-container-{{ list.id }}">
            <h2 class="title is-4" style="color: black; display: inline-block;">{{ list.title }}</h2>
            <a onclick="toggleEdit('{{ list.id }}')" class="button is-small is-light">Rename</a>
        </div>
        <form id="edit-form-{{ list.id }}" action="{{ url_for('main.update_list_title', list_id=list.id) }}" method="post" style="display: none;">
            <input type="text" class="input is-small" name="new_title" value="{{ list.title }}">
            <button type="submit" class="button is-small is-info">Save</button>
        </form>
    
        <!-- Delete Button -->
        <form action="{{ url_for('main.delete_list', list_id=list.id) }}" method="post" style="position: absolute; top: 10px; right: 10px;">
            <button type="submit" class="button is-small is-light">Delete</button>
        </form>
        
        <!-- Form to Add New Task -->
        <form action="{{ url_for('main.add_task', list_id=list.id) }}" method="post">
            <div class="field">
                <div class="control">
                    <input class="input" type="text" name="taskContent" placeholder="Enter new task" required>
                </div>
            </div>
            <div class="control">
                <button type="submit" class="button is-small is-link">Add Task</button>
            </div>
        </form>

        <ul>
            {% for item in list.items if item.parent_id is none %}
                {{ render_item(item) }}
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<script>
function toggleSubItems(itemId) {
    var element = document.getElementById('sub-items-' + itemId);
    if (element) {
        element.classList.toggle('is-hidden');
    }
}


function toggleEdit(listId) {
    const titleContainer = document.getElementById(`title-container-${listId}`);
    const editForm = document.getElementById(`edit-form-${listId}`);
    if (editForm.style.display === "none") {
        editForm.style.display = "block";
        titleContainer.style.display = "none";
    } else {
        editForm.style.display = "none";
        titleContainer.style.display = "block";
    }
}

function handleKeyPress(e, listId) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Prevent form submission
        const newTitle = document.getElementById(`input-${listId}`).value.trim();
        // Update the title on the server
        fetch(`{{ url_for('main.update_list_title', list_id=0) }}`.replace('0', listId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title: newTitle }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`title-${listId}`).textContent = newTitle;
                toggleEdit(listId); // Hide the input field again
            } else {
                alert('Error updating list title');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('Error updating list title');
        });
    }
}
</script>

{% endblock %}

{% macro render_item(item, level=0) %}
<li>
    {{ item.content }}
    <!-- Button to delete task could be added here -->
    {% if item.children %}
    <a href="javascript:void(0);" onclick="toggleSubItems({{ item.id }})">Toggle Sub-Items</a>
    <ul id="sub-items-{{ item.id }}" class="{{ 'is-hidden' if level >= 1 }}">
        {% for sub_item in item.children %}
            {{ render_item(sub_item, level + 1) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}
